<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="osCrushstyle.css">
    <link rel="stylesheet" href="jquery-ui.min.css">
    <title></title>

  </head>
  <body>

    <div id="test">

    </div>
    <div class="mainConatiner">
      <div class="board">
        <div class="header">
        <div class="sound" value="1" title="It's On!">&#x1f50a;</div>

        <svg height="500" width="500">
          <circle cx="50" cy="50" r="10" stroke="black" stroke-width="3" fill="white" />
          <circle cx="70" cy="50" r="10" stroke="black" stroke-width="3" fill="white" />
          <circle cx="90" cy="50" r="10" stroke="black" stroke-width="3" fill="white" />
          <circle cx="110" cy="50" r="10" stroke="black" stroke-width="3" fill="white" />
        </svg>
        </div>
        <div class="gameBoard" >
          <div class="colum" id="c1"></div>
          <div class="colum" id="c2"></div>
          <div class="colum" id="c3"></div>
          <div class="colum" id="c4"></div>
          <div class="colum" id="c5"></div>
          <div class="colum" id="c6"></div>
          <div class="colum" id="c7"></div>
          <div class="colum" id="c8"></div>
          <div class="scoreBoard" id="scoreBoard">00</div>
        </div>

      </div>

    </div>
      <script src="jquery-3.1.1.min.js"></script>
      <script src="d3.min.js"></script>
      <script src="jquery-ui.min.js"></script>
        <script type="text/javascript" src="osCrush2.js"> </script>
    <script type="text/javascript">
    var once=false;
  function animateCircles(){
    var data=[1,3,5,7];
    if(!once){
       once=true;
    }else {
       $("circle")[0].attributes.r.value=10;
       $("circle")[1].attributes.r.value=10;
       $("circle")[2].attributes.r.value=10;
       $("circle")[3].attributes.r.value=10;
       once=false;
    }
      d3.selectAll("circle")
        .data(data)
        .transition()
        .duration(750)
        .delay(function(d,i) { return d * 100;})
        .attr("r", function(d) {return Math.sqrt(d); });
  }
//console.log($("circle")[0].attributes.r.value=20);

setInterval(function(){animateCircles();},1500);
    $( document ).tooltip();
    $( ".sound" ).tooltip({
      classes: {
        "ui-tooltip": "highlight"
      }
    });


    var size=30;
    var cellsSize=50;
    var startPointLeft=false;
    var startPointTop=false;
    var endPointTop=false;
    var endPointLeft=false;
    var iconArray=osCrush.getIconArray();
    var boardColumns=["c1","c2","c3","c4","c5","c6","c7","c8"];
    var iconArray=["android.png","apple.png","freebsd.png","linux.png","ubuntu.png","windows.png"];
    function clearBoard(){
      for(var i =0; i<8; i++){
        $("#c"+i).empty();
      }
    }
              osCrush.addListener("gridListener", function(){
                clearBoard();
                for(var i =0; i<osCrush.getGrid().length; i++){
                for(var j =0; j<osCrush.getGrid()[i].length; j++){
                  var elt =parseInt(osCrush.getGrid()[i][j]);
                  var t=j*cellsSize, l=i*cellsSize ;
                  if(elt===-1){
                    $("#"+boardColumns[i]).append("<div class='cellsTodelete' style='position: absolute; top:"+t+"px; left:"+l+"px;' value="+elt+"> <img class='cellsImg'   draggable='true' ondrop='drop(event)' ondragover='allowDrop(event)' src='gif.gif' alt=''style='width:inherit; height:inherit;' value="+elt+"> </div>");
                  }else if(elt===0){
                    $("#"+boardColumns[i]).append("<div class='cells' style='position: absolute; top:"+t+"px; left:"+l+"px;' value="+elt+"> <img class='cellsImg'   draggable='true' ondrop='drop(event)' ondragover='allowDrop(event)' src="+iconArray[elt]+" alt='' value="+elt+"> </div>");
                  }else if (elt===1) {
                    $("#"+boardColumns[i]).append("<div class='cells' style='position: absolute; top:"+t+"px; left:"+l+"px;' value="+elt+"> <img class='cellsImg'  draggable='true' ondrop='drop(event)' ondragover='allowDrop(event)'src="+iconArray[elt]+" alt=''value="+elt+"> </div>");
                  }else if (elt===2) {
                     $("#"+boardColumns[i]).append("<div class='cells' style='position: absolute; top:"+t+"px; left:"+l+"px;' value="+elt+"> <img class='cellsImg'   draggable='true' ondrop='drop(event)' ondragover='allowDrop(event)'src="+iconArray[elt]+" alt='' value="+elt+"> </div>");
                  }else if (elt===3) {
                     $("#"+boardColumns[i]).append("<div class='cells' style='position: absolute; top:"+t+"px; left:"+l+"px;' value="+elt+"> <img class='cellsImg'   draggable='true' ondrop='drop(event)'ondragover='allowDrop(event)' src="+iconArray[elt]+" alt='' value="+elt+"> </div>");
                  }else if (elt===4) {
                     $("#"+boardColumns[i]).append("<div class='cells' style='position: absolute; top:"+t+"px; left:"+l+"px;' value="+elt+"> <img class='cellsImg'   draggable='true' ondrop='drop(event)'ondragover='allowDrop(event)' src="+iconArray[elt]+" alt='' value="+elt+"> </div>");
                  }else if (elt===5) {
                     $("#"+boardColumns[i]).append("<div class='cells' style='position: absolute; top:"+t+"px; left:"+l+"px;' value="+elt+"> <img class='cellsImg'   draggable='true' ondrop='drop(event)'ondragover='allowDrop(event)' src="+iconArray[elt]+" alt='' value="+elt+"> </div>");
                  }

                }
              }
            });
var condition_first=true;
var first_target=false;
var second_target=false;
var mouse_down_trigered=false;

              $(".gameBoard").click(function(e){
                if(e.target.localName==="img"){
                  $( e.target).animate({  width: "+=15", height: "+=15"},300,function() {
                    console.log( "done!" );
                    $( e.target).animate({  width: "-=15", height: "-=15"},300,function() {console.log( "done!" );});
                  });
                }
              });


              $(".gameBoard").mousedown(function(e){
                if(e.target.localName==="img"){
                  console.log(osCrush.lastTargetObtained());
                  if(osCrush.lastTargetObtained()==="first"){
                    first_target=e;
                    //myFirst_target.set(e);
                    osCrush.setFirstTarget(e);
                    //condition_first=false;
                    osCrush.obtainedTarget(1,e);
                  }else {
                    //then second condition, second click
                    second_target=e;
                    osCrush.setSecondTarget(e);
                  //  flip_with_FirstTrarget(myFirst_target,e);
                    osCrush.flipTargets();
                    updateGrid();
                    if(!osCrush.checkGrid("just_simulation")){
                      setTimeout(function(){similation_failed();},250);
                    }
                    osCrush.obtainedTarget(2,e);
                  }
                }else {
                  console.log("error");
                }
              });


              function drop(e) {

                if(e.target.localName ==="img"){
                  second_target=e;
                  osCrush.setSecondTarget(e);
                  osCrush.flipTargets();
                  updateGrid();
                if(!osCrush.checkGrid("just_simulation")){
                  setTimeout(function(){similation_failed();},250);
                }
                 osCrush.obtainedTarget(2,e);
               }else {
                 console.log('error');
               }
              }

              function allowDrop(event) {
                 event.preventDefault();
              }
              $(".sound").click(function(e){
                $(this).empty();
                if($(this)[0].attributes.value.value==="1"){
                    $(this).append("&#x1f507;");
                    $(this)[0].attributes.value.value=0;
                      $( ".sound").tooltip( "option", "content", "It's Off!" );
                }else {
                  $(this).append("&#x1f50a;");
                  $(this)[0].attributes.value.value=1;
                  $( ".sound").tooltip( "option", "content", "It's On!" );

                }
              });
osCrush.initialize();

function dropAll_from(i,elts,count){
  for(var y=0; y<elts.length; y++){
    if(elts[y].attributes.value.value !=="-1"){
      var nextPosition=(parseInt($(elts[y]).css("top"))+(50));
      $(elts[y]).css("top",nextPosition);

    }else {

      return;
    }

  }
}
function addOne_top(where){
    var rand=Math.floor((Math.random() * 6) + 0);
  $("#"+boardColumns[where]).prepend("<div class='cells' style='position: absolute; top:"+0+"px; left:"+where*50+"px;' value="+rand+"> <img class='cellsImg'   draggable='true' ondrop='drop(event)' ondragover='allowDrop(event)' src="+iconArray[rand]+" alt='' value="+rand+"> </div>");
}
function dropAnime1(){
  for(var i=0; i<osCrush.getGrid().length; i++){
    var elts=$("#"+boardColumns[i])[0].childNodes;
    var count =0;
    for(var j =0; j<elts.length; j++){
        if(elts[j].attributes.value.value ==="-1" ){
          dropAll_from(i,elts,count);
          var t=parseInt($(elts[j])[0].style.top);
          var l=parseInt($(elts[j])[0].style.left);
          createBubbles(t,l,30);
          $(elts[j]).remove();
          addOne_top(i);
          break;
        }else {
        }
    }
  }
}
var score=0;
function updateScore(x){
   score+=x;
$(".scoreBoard").html(score);
}
var totalPoint=0;
function createBubbles(t,l,point){
  var rand=Math.floor((Math.random() * 3) + 0);
  var col=["white","lightblue","lightgreen"];
  totalPoint+=point;
  $(".gameBoard").append("<p style='z-index:10; color:"+col[rand]+"; font-size:1.5em; position:absolute; top:"+t+"px; left:"+l+"px;'>+"+point+"</p>");
  //console.log($(".gameBoard")[0].lastChild);
  $($(".gameBoard")[0].lastChild).animate({
        left: '100px',
        top: '-85px'
    },600,function(){
      $(this).remove();
      if(totalPoint!==0){
        $(".gameBoard").append("<p style='z-index:10; color:lightblue; font-size:1.5em;position:absolute; top:"+(-85)+"px; left:"+109+"px;'>+"+totalPoint+"</p>");
         updateScore(totalPoint);
         totalPoint=0;

      }
        $($(".gameBoard")[0].lastChild).animate({
              left: '50px',
              top: '-85px'
          },500,function(){
            $(this).remove();
             $(".scoreBoard").animate({
               //left: '-=10',
               fontSize: '+=10px'
             },100,function(){
               $(this).animate({
                 //left: '+=10',
                 fontSize: '-=10px'
                // height: '-=10px'
              },100);

             });
          });
    });
}
function updateGrid(){
  for(var i =0; i<osCrush.getGrid().length; i++){
    var elts1=$("#"+boardColumns[i])[0].childNodes;
    for(var j =0; j<elts1.length; j++){
      //console.log(elts1[j].attributes.value);
      //osCrush.grid[i][j]=elts1[j].attributes.value.value;
      osCrush.updateGrid(i,j,elts1[j].attributes.value.value);
    }
  }

}
// function test(){
//   $("#test").empty();
//   for(var i =0; i<osCrush.grid.length; i++){
//     for(var j =0; j<=osCrush.grid[i].length; j++){
//       var c =document.getElementById("test");
//       if(j===osCrush.grid[i].length){
//         c.innerHTML+= "<br>";
//       }else {
//           c.innerHTML+= osCrush.grid[i][j];
//       }
//     }
//   }
// }
function similation_failed(){
  if(osCrush.obtainedTarget("return")===2){
    osCrush.setFirstTarget(first_target);
    osCrush.setSecondTarget(second_target);
    osCrush.flipTargets();
  }else {
    console.log("no target yet");
  }
}

var interval =setInterval(function(){
  dropAnime1();
  updateGrid();
osCrush.checkGrid();

  //test(); //this is just for a test to see the grid
},250);


    </script>
  </body>
</html>
